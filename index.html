<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<style type="text/css">
  html { height: 100% }
  body { height: 100%; margin: 0px; padding: 0px }
  #map_canvas { height: 50%; width: 50%; }
</style>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
<script src="https://www.google.com/jsapi?key=ABQIAAAAvspuEcCm81S-14XRfJfrbhTbLzYENJ5D9v8phcBnu19o6hbNrxQlyRkpBFCYzG6xqnV-uk2-KXUjmw" type="text/javascript"></script>
<script type="text/javascript">
var map;
var markers = [];

function initialize_map() {
    var latlng = new google.maps.LatLng(-34.397, 150.644);
    var myOptions = {
        zoom: 8,
        center: latlng,
        mapTypeId: google.maps.MapTypeId.ROADMAP
    };
    map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
/*    for ( var i = 0; i < markers.length; i++ ) {
        var marker = new google.maps.Marker({
            position: new google.maps.LatLng(markers[i]['loc']['lat'], markers[i]['loc']['lng']),
            map: map,
            title: markers[i]['name'],
            icon: "http://localhost/~james/elec/marker.php?s=" + markers[i]['2pp']
        });
    }*/
}

function load_markers(results) {
    // Clear the old markers
    var i;
    for ( i = 0; i < markers.length; i++ ) {
        markers[i].setMap(null);
    }
    markers = [];
    
    var bound;
    var pos, prev_pos;
    
    for ( i = 0; i < results.length; i++ ) {
        if ( typeof results[i]['loc'] === 'undefined' ) continue;
        if ( typeof results[i]['2pp'] === 'undefined' ) continue;
        if ( results[i]['2pp']['alp'] == 0 && results[i]['2pp']['lnp'] == 0 ) continue;
        prev_pos = pos;
        pos = new google.maps.LatLng(results[i]['loc']['lat'], results[i]['loc']['lng']);
        var marker = new google.maps.Marker({
            position: pos,
            map: map,
            title: results[i]['name'],
            icon: "marker.php?v=" + Math.round(parseFloat(results[i]['2pp']['alp'])).toString() + "&s=" + results[i]['2pp']['tot']
        });
        markers.push(marker);
        if ( !bound ) {
            bound = new google.maps.LatLngBounds(pos, pos);
        }
        else {
            bound = bound.union(new google.maps.LatLngBounds(prev_pos, pos));
        }
    }
    
    map.fitBounds(bound);
}

google.load('jquery', '1');

google.setOnLoadCallback(function() {
    $(function() {
        initialize_map();
        $('.electorate-link').click(function() {
            var url = this.href;
            jQuery.getJSON(url, function(data) {
                if ( data.error )
                    alert(data.reason);
                else
                    load_markers(data.polling_places);
            });
            return false;
        });
    });
});
</script>
</head>
<body>
    <div id="map_canvas"></div>
    <div id="list">
        <ul>
            <li>
                <a href="results.php?id=102" class="electorate-link">Fraser</a>
            </li>
            <li>
                <a href="results.php?id=194" class="electorate-link">Denison</a>
            </li>
            <li>
                <a href="results.php?id=167" class="electorate-link">Kennedy</a>
            </li>
            <li>
                <a href="results.php?id=305" class="electorate-link">Hasluck</a>
            </li>
            <li>
                <a href="results.php?id=207" class="electorate-link">Corangamite</a>
            </li>
            <li>
                <a href="results.php?id=190" class="electorate-link">Sturt</a>
            </li>
            <li>
                <a href="results.php?id=182" class="electorate-link">Boothby</a>
            </li>
            <li>
                <a href="results.php?id=196" class="electorate-link">Lyons</a>
            </li>
        </ul>
    </div>
</body>
</html>